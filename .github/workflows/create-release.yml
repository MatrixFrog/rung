name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.3.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  create-release:
    name: Bump Version and Tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format. Use semver (e.g., 0.3.0)"
            exit 1
          fi

      - name: Check tag doesn't already exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Update workspace version
        run: |
          VERSION="${{ inputs.version }}"

          # Update workspace.package.version
          sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml

          # Update workspace.dependencies for internal crates
          sed -i 's/rung-core = { version = "[^"]*"/rung-core = { version = "'"$VERSION"'"/' Cargo.toml
          sed -i 's/rung-git = { version = "[^"]*"/rung-git = { version = "'"$VERSION"'"/' Cargo.toml
          sed -i 's/rung-github = { version = "[^"]*"/rung-github = { version = "'"$VERSION"'"/' Cargo.toml

      - name: Verify changes
        run: |
          echo "Updated Cargo.toml:"
          grep -E '^version|rung-(core|git|github)' Cargo.toml

          echo ""
          echo "Verifying build..."

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify build compiles
        run: cargo check

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Cargo.toml
          git commit -m "chore: release v${{ inputs.version }}"
          git tag -a "v${{ inputs.version }}" -m "v${{ inputs.version }}"
          git push origin main --follow-tags

